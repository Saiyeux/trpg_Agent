# AI-TRPG 系统设计文档

## 1. 系统概述

AI-TRPG 是一个基于大语言模型的桌游角色扮演游戏系统，支持智能场景生成、意图识别和多AI后端。系统采用模块化架构，提供沉浸式的TRPG游戏体验。

### 1.1 核心特性
- 🎭 **智能场景生成** - AI驱动的动态场景描述和故事推进
- 🤖 **意图识别系统** - 自动分析玩家行为意图并分类统计
- 📊 **数据统计分析** - 详细的游戏行为分析和趋势报告
- 🔧 **多AI后端支持** - 支持Ollama和LM Studio两种AI服务
- 📝 **详细日志记录** - 完整的游戏过程和AI交互记录
- ⚙️ **灵活配置系统** - 可配置的AI模型和游戏参数

## 2. 系统架构

### 2.1 总体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    AI-TRPG 系统                          │
├─────────────────────────────────────────────────────────┤
│  main.py (入口)                                         │
├─────────────────────────────────────────────────────────┤
│                   核心模块 (core/)                       │
│  ┌─────────────────┐    ┌─────────────────────────────┐ │
│  │  GameEngine     │    │       GameState             │ │
│  │  (游戏引擎)      │    │     (状态管理)              │ │
│  └─────────────────┘    └─────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│                   AI模块 (ai/)                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │               ModelClient                           │ │
│  │            (AI模型客户端)                            │ │
│  └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│                  工具模块 (utils/)                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ │
│  │IntentAnalyz-│ │ActionDispat-│ │     GameLogger      │ │
│  │er(意图分析) │ │cher(行动分发)│ │    (日志记录)       │ │
│  └─────────────┘ └─────────────┘ └─────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│                  配置模块 (config/)                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │              ConfigManager                          │ │
│  │             (配置管理器)                             │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 2.2 模块详细设计

#### 2.2.1 核心模块 (core/)

**GameEngine (游戏引擎)**
- **职责**: 系统的核心控制器，协调所有模块工作
- **主要功能**:
  - 游戏会话管理
  - 用户输入处理  
  - AI交互协调
  - 游戏状态维护
  - 优雅退出处理

**GameState (状态管理)**
- **职责**: 维护TRPG游戏的所有状态信息
- **主要功能**:
  - 游戏状态存储和更新
  - 历史记录管理
  - 智能上下文提取
  - 回合计数和追踪

#### 2.2.2 AI模块 (ai/)

**ModelClient (AI模型客户端)**
- **职责**: 统一的大语言模型调用接口
- **支持后端**:
  - Ollama (本地模型服务)
  - LM Studio (GUI管理器)
- **主要功能**:
  - 场景生成
  - 意图分析
  - 多后端适配
  - 错误处理和重试

#### 2.2.3 工具模块 (utils/)

**IntentAnalyzer (意图分析器)**
- **职责**: 玩家意图识别、分类和统计分析
- **主要功能**:
  - 意图数据记录和存储
  - 实时统计分析
  - 意图分布报告
  - 历史数据查询

**ActionDispatcher (行动分发器)**
- **职责**: 根据玩家意图分类调用对应处理函数
- **主要功能**:
  - 意图到函数的映射
  - 行动处理函数调用
  - 扩展性支持
  - 未知行动的默认处理

**GameLogger (日志记录器)**
- **职责**: 记录游戏的详细日志和AI交互
- **主要功能**:
  - AI模型交互日志
  - 游戏事件记录
  - 会话统计报告
  - 带时间戳的日志文件管理

#### 2.2.4 配置模块 (config/)

**ConfigManager (配置管理器)**
- **职责**: 系统配置文件管理和验证
- **主要功能**:
  - 配置文件加载和保存
  - 多AI后端配置管理
  - 交互式配置设置
  - 配置验证和默认值

## 3. 数据流设计

### 3.1 游戏主循环数据流

```
用户输入 → 意图分析 → 行动分发 → 场景生成 → 状态更新 → 显示结果
    ↓         ↓         ↓         ↓         ↓         ↓
  记录日志   记录意图   执行行动   记录场景   更新历史   等待输入
```

### 3.2 双AI调用模式

**当前实现**:
```
玩家行动 → [AI1: 意图分析] → [AI2: 场景生成] → 结果显示
```

**存在问题**:
- AI1负责意图分析，AI2负责场景生成
- 两个AI之间缺乏有效协调
- 场景生成缺少行动执行结果

## 4. 配置系统设计

### 4.1 配置文件结构

```json
{
  "api": {
    "type": "ollama|lm_studio"
  },
  "ollama": {
    "base_url": "http://localhost:11434/api/generate",
    "model": "qwen2.5:3b",
    "context_limit": 32000,
    "available_models": ["qwen2.5:3b", "qwen2.5:7b", ...]
  },
  "lm_studio": {
    "base_url": "http://localhost:1234/v1/chat/completions",
    "model": "current_loaded",
    "context_limit": 128000
  },
  "game": {
    "context_history_limit": 3,
    "auto_adjust_context": true,
    "max_turns": 1000
  },
  "logging": {
    "log_file": "logs/trpg_game.log",
    "log_level": "INFO",
    "enable_console_output": true
  }
}
```

### 4.2 多后端支持

**Ollama特点**:
- 本地运行的开源AI服务
- 支持多模型切换
- 上下文限制: 32K tokens
- 适合轻量化部署

**LM Studio特点**:
- 图形界面的AI模型管理器
- 支持高质量大模型
- 上下文限制: 128K tokens
- 单模型加载机制

## 5. 当前系统问题分析

### 5.1 核心问题

1. **AI角色混淆**
   - 意图分析AI扮演"分析师"角色
   - 场景生成AI扮演"城主"角色，但缺乏具体执行权
   
2. **Prompt设计缺陷**
   - 场景生成时缺少"执行结果"概念
   - AI被要求描述氛围而非执行结果
   - 没有明确告诉AI要回答"找到了什么"

3. **上下文信息不足**
   - 场景生成时只有模糊的"生成新场景"指令
   - 缺少玩家具体行动和期望结果的信息

### 5.2 表现症状

- 玩家询问"找到了什么"时，AI回避给出具体结果
- 更多描述氛围和情感，而非实际的游戏进展
- 缺乏明确的行动反馈和结果

## 6. 未来扩展规划

### 6.1 RAG功能集成

**目标**: 添加检索增强生成功能，作为上下文存储和检索系统

**功能规划**:
- **向量数据库**: 存储游戏世界知识、NPC信息、物品描述等
- **语义检索**: 根据玩家行动检索相关背景信息
- **上下文增强**: 为AI提供更丰富的背景知识
- **Function Call检索**: 支持基于检索的函数调用

**技术栈**:
- 向量数据库: ChromaDB / Faiss / Qdrant
- 嵌入模型: sentence-transformers / OpenAI embeddings
- 检索策略: 混合检索 (语义 + 关键词)

### 6.2 多模型分工架构

**目标**: 实现专业化的多模型协作系统

**分工设计**:

1. **意图识别专用模型**
   - 推荐模型: qwen2.5:3B
   - 职责: 快速、准确的意图分类
   - 特点: 轻量化、响应快速

2. **文本生成专用模型** 
   - 推荐模型: Hermes-4-14B
   - 职责: 高质量的场景描述和对话生成
   - 特点: 创意能力强、文学表达优秀

3. **检索与执行专用模型**
   - 候选模型: 待定 (可能是代码生成模型)
   - 职责: 函数调用、逻辑推理、结果计算
   - 特点: 逻辑性强、执行准确

**架构优势**:
- 各模型发挥专长，提高整体效果
- 可独立优化和替换单个模型
- 降低单个模型的复杂度要求
- 支持异构模型协作

### 6.3 增强的游戏机制

**即将添加的功能**:
- 物品系统和背包管理
- NPC对话系统
- 技能和属性系统  
- 地图和位置系统
- 任务和剧情分支系统

## 7. 技术栈总结

### 7.1 当前技术栈

- **编程语言**: Python 3.8+
- **AI后端**: Ollama / LM Studio
- **配置格式**: JSON
- **日志系统**: 自定义日志记录器
- **CLI框架**: argparse

### 7.2 未来技术栈扩展

- **向量数据库**: ChromaDB / Faiss
- **嵌入模型**: sentence-transformers
- **Web界面**: FastAPI + React (可选)
- **数据库**: SQLite / PostgreSQL (持久化存储)
- **消息队列**: Redis (多模型协作)

## 8. 部署和运维

### 8.1 系统要求

- Python 3.8+
- 至少4GB RAM (单模型)
- 至少16GB RAM (多模型分工)
- 运行中的AI服务 (Ollama或LM Studio)

### 8.2 安装部署

```bash
# 克隆项目
git clone <repository>

# 安装依赖
pip install -r requirements.txt

# 配置系统
python main.py config

# 启动游戏
python main.py
```

### 8.3 监控和维护

- 日志文件: `logs/trpg_game_YYYYMMDD_HHMMSS.log`
- 配置文件: `config/game_config.json`
- 性能监控: 通过日志分析响应时间和错误率

---

*文档版本: 1.0*  
*最后更新: 2025-09-10*  
*维护者: AI-TRPG 开发团队*